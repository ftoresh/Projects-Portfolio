---
title: "Data Science Portfolio"
author: "Fernando Torres H."
date: "07/09/2018"
output:
  ioslides_presentation:
    theme: lumen
    fig_width: 9 
    fig_height: 6
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align="center", out.width = "900px")

```


```{r global, include = FALSE}

library(readxl)
library(caTools)
library(forecast)
library(caret)
library(tidyverse)
library(astsa)
library(ggthemes)
library(gridExtra)


### Parameters
value_hotel<- "Cucuve"
limite_occ<-  70

### Main revenue dataset
# 1) Import multiple files (Base)

## Set working directory (Files before February 2018)
setwd("~/Google Drive/Data Analysis/Bases de Datos/Colibri/Data Hoteles")

## Create a list from these files
list.filenames<-list.files(pattern=".xls$")
# list.filenames

## Create an empty list that will serve as a container to receive the incoming files
list.data<-list()

## Create a loop to read in your data
for (i in 1:length(list.filenames))
{
  list.data[[i]]<-read_excel(list.filenames[i], skip = 0)
}

## Add the names of your data to the list
names(list.data)<-list.filenames

## Join all the datasets of the list into one dataset
dataset<- bind_rows(list.data, .id = "Month")

# Pick the relevant information
## Delete empty columns 
dataset<- Filter(function(x)!all(is.na(x)), dataset)
dataset <- dataset[,colSums(is.na(dataset))<nrow(dataset)] 

# Delete empty NA rows
dataset<- dataset %>% na.omit()

##Change names to dataset
dataset<-  dataset %>% select(Month, Date, Available_Rooms = 'Available Rooms', Night_Sold = 'Night Sold', Complimentary, Occ = 'Occ%' ,ADR, Rev_Par = 'Rev Par', Pax, Room_charges = 'Room Charges')

## Remove unwanted "," from numbers
dataset<- dataset %>% mutate_if(is.character, funs(gsub(",","",.)))

## Change to numeric the columns
dataset<- mutate_at(dataset, vars(Available_Rooms:Room_charges), funs(as.numeric))

## Separate column Date into day in words and number
dataset<- separate(dataset, Date, c("Date", "Day"))

## Leave the number of the month and year without .xls
dataset<- separate(dataset, Month, c("Hotel", "Month", "Year"))

## Create new variables
## Create variable Wholeyear_week  
dataset<- mutate(dataset, Complete_date = paste(dataset$Year,"/", dataset$Month,"/", dataset$Date, sep = "" ))

dataset$Complete_date<- as.Date(dataset$Complete_date, format = "%Y/%m/%d")
Wholeyear_week<- strftime(dataset$Complete_date, format = "%V")
dataset$Wholeyear_week <- Wholeyear_week

## Create variable Night_Sold_Complete
dataset<- dataset %>% mutate(Night_Sold_Complete = Night_Sold + Complimentary)

## Create variable Holiday
holidays<- as.Date(c("01-January-2016", "08-February-2016", "09-February-2016", 
                     "25-March-2016", "24-May-2016", "01-May-2016", "10-August-2016", 
                     "09-October-2016","02-November-2016", "03-November-2016", 
                     "25-December-2016", "01-January-2017", "02-January-2017", "27-February-2017", 
                     "28-February-2017", "14-April-2017", "01-May-2017", "24-May-2017", 
                     "10-August-2017", "09-October-2017", "02-November-2017", "03-November-2017", 
                     "25-December-2017"), format = "%d-%B-%Y") %>%
  strftime(format = "%V")

dataset<- mutate(dataset, Holiday = ifelse(dataset$Wholeyear_week %in% holidays, "yes", "no"))

## Create variable GoodWeather (june to november cold, november june warm)
dataset<- mutate(dataset, GoodWeather = ifelse(dataset$Month %in% c("01","02","03","04","05","06","11","12"), "yes", "no"))

## Create variable Weekend
dataset<- mutate(dataset, Weekend = ifelse(dataset$Day %in% c("Sat", "Sun"), "yes", "no"))

## Create variable Ciudad
dataset<- dataset %>% mutate(Ciudad = case_when(Hotel %in% c("Cucuve", 
                                                             "Angermeyer", 
                                                             "Aquamarine", 
                                                             "Cottages", 
                                                             "Espana",
                                                             "GalapagosSuites",
                                                             "LaZayapa",
                                                             "SantaFe" ) ~ "Galapagos",
                                                Hotel %in% "LaTerraza" ~ "Puerto Lopez"))


## Create variable ADR_Mercado
dataset_ADR_Galapagos<- filter(dataset, Ciudad == "Galapagos") %>%
  group_by(Ciudad, Complete_date) %>%
  summarise(ADR_Mercado = mean(ADR, na.rm = TRUE)) %>%
  gather(Ciudad_ADR, ADR_Mercado, -c(Ciudad, Complete_date)) %>%
  select(Ciudad, Complete_date, ADR_Mercado)

dataset_ADR_PuertoLopez<- filter(dataset, Ciudad == "Puerto Lopez") %>%
  group_by(Ciudad, Complete_date) %>%
  summarise(ADR_Mercado = mean(ADR, na.rm = TRUE)) %>%
  gather(Ciudad_ADR, ADR_Mercado, -c(Ciudad, Complete_date)) %>%
  select(Ciudad, Complete_date, ADR_Mercado) 

dataset<- union(dataset_ADR_Galapagos, dataset_ADR_PuertoLopez) %>% left_join(dataset, by = c("Complete_date", "Ciudad"))

# Create variable binari when Occ > x%
dataset<- dataset %>% mutate(OccBinari = case_when(Occ >= limite_occ ~ "Yes",
                                                   Occ <= limite_occ ~ "No" ))

## Order the dataset by date
dataset<- dataset %>% arrange(Complete_date)

# Convert to factor 
dataset$Ciudad <- as.factor(dataset$Ciudad)
dataset$Hotel <- as.factor(dataset$Hotel)


### Create National_Index dataset


# 1) Import the data 
## Import National Index
## Import complete dataset of national indexes to make forecast 
setwd("~/Google Drive/Data Analysis/Bases de Datos/Colibri/Data complementaria")
# Be aware that there are empty spaces in the two next months of the dataset
dataset_national_index_complete<- read_excel("~/Google Drive/Data Analysis/Bases de Datos/Colibri/Data complementaria/dataset_national_index_excel.xlsx", sheet = "Sheet 1", skip = 1)


```


<br>

## **Price Optimisation ML Model**

### **The pipeline includes three steps:**

* **Forecasting of the average price of luxury hotels.**
<br>
In the feature creation phase, this variable was found to be a good predictor.

* **Find the optimum price which yields the highest probability of having a high room ocuppacy.**
<br>
A classification model using the Random Forest algorithm is used. This is a novel approach to price optimisation, as standar Operational Research practices would use other methods, however more difficult to put into production.

* **Reporting**
<br>
Create easy to read visualisations that could help the Revenue Manager make decisions about the pricing.

<br>


```{r, fig.align="center", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

#### Forecast ADR_Lux
# Make dataset a time series
vectorT<- dataset_national_index_complete %>% select(National_ADR_Lux) %>% as.ts()

# Main Information
value_week<- strftime(as.Date(Sys.Date(), format = "%Y/%m/%d"), format = "%V")
forecast_window<- length(which(is.na(dataset_national_index_complete$National_ADR_Lux))) # Months to forecast ADR_Lux
test_window<- round(length(vectorT)*0.2)

### Forecast National ADR_Lux

## Chose the best model that fits the data
## Make the test set
train <- subset(vectorT, end = length(vectorT) - test_window) 

## Fit the desired model to the training data 
lambda<- vectorT %>% BoxCox.lambda()
classifierT1 <- auto.arima(train, lambda = lambda, stepwise = FALSE, seasonal = FALSE)

## Check that model has white noise residuals
checkresiduals(classifierT1)

# Fit ARIMA model tunning the parameters

# Trial of different values p,q,d related to the ones of auto.arima 
## Check which values of p,q,d make the AIC & BIC smaller
# diff(vectorT) %>% sarima(0,1,2) 

## Fit the the ARIMA model with the new paramethers
lambda<- vectorT %>% BoxCox.lambda()
classifierT11 <- train %>% Arima(order = c(0,1,2), lambda = lambda, seasonal = FALSE)

## Check that model has white noise residuals
checkresiduals(classifierT11)

## Use accuracy() to compare the paramethers of auto.arima vs the manual fit
for_classifierT1 <- forecast(classifierT1, h = forecast_window) 
for_classifierT11 <- forecast(classifierT11, h = forecast_window)

# Produce forecasts for each model
## Train full time series
classifierFull1 <- auto.arima(vectorT, lambda = lambda, stepwise = FALSE, seasonal = FALSE)
classifierFull11 <- vectorT %>% Arima(order = c(0,1,2), lambda = lambda, seasonal = FALSE)

## Forecast full time series
for_classifierFull1 <- forecast(classifierFull1, h = forecast_window)
for_classifierFull11 <- forecast(classifierFull11, h = forecast_window)
National_ADR_Lux_predicted<- mean(for_classifierFull1$mean)



# 2) Join national index with dataset

# Replace unknown values with forecasted values
dataset_national_index_complete<- dataset_national_index_complete %>% replace_na(list(National_ADR_Lux = National_ADR_Lux_predicted))

## Convertir en factor el mes
dataset_national_index_complete$Month<- as.factor(dataset_national_index_complete$Month)
dataset_national_index_complete$Year<- as.factor(dataset_national_index_complete$Year)

# Joint national index with dataset by month and year
dataset<- left_join(dataset, dataset_national_index_complete, by = c("Month", "Year"))

## Factoring variables
dataset<- mutate_at(dataset, vars(c(Hotel:Day), Wholeyear_week, Holiday:Weekend), funs(as.factor))

# Convert NA values
dataset$ADR <- ifelse(is.na(dataset$ADR), 
                      ave(dataset$ADR, FUN = function(x) mean(x, na.rm = TRUE)), dataset$ADR)

# Eliminate ADR = 0
temp<- dataset %>% filter(Hotel == value_hotel)
dataset$ADR[dataset$ADR == 0] <- mean(temp$ADR, na.rm = TRUE)
remove(temp)
```

<br>


## **Supporting Visualisations**

```{r, fig.align="center", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

############################################# Plot Forecast ADR_Lux ###########################################################

## Plot the Forecast

autoplot(for_classifierFull1, loadings.label=FALSE, loadings=FALSE) + 
  autolayer(vectorT) + 
  labs(title = paste("Luxury Hotels' ADR Forecast"), subtitle = (strftime(as.Date(Sys.Date(), format = "%Y/%m/%d"), format = "%b")), x = "Month", y = "ADR") +
  theme_economist() + 
  scale_color_economist(labels=c("")) + 
  theme(plot.title = element_text(size=20), 
        plot.subtitle = element_text(size = 12), 
        text = element_text(family = "Tahoma"), 
        legend.position = "right") +
  guides(color=guide_legend(title="Luxury Hotels' ADR")) 

```

Average price of luxury hotels forecasting using ARIMA; this value is later used as a predictor of the main model. 

<br>


## **SUBTITLE** 

**SUBSUBTITLE**

* BULLET TITLE
<br>
BULLET TEXT

* BULLET TITLE
<br>
BULLET TEXT
<br>
<br>


**SUBSUBTITLE**

* BULLET POINT
<br>
BULLET DESCRIPTION

* BULLET POINT
<br>
BULLET DESCRIPTION
<br>
<br>


**SUBTITLE**

* BULLET POINT
* BULLET POINT
 
<br>
 
**SUBTITLE**

* BULLET POINT
* BULLET POINT

